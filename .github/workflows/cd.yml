name: CD - Deploy to VPS

on:
  push:
    branches: [main]
    paths:
      - 'pipelines/**'
      - 'Dockerfile'
      - 'requirements.txt'
      - 'docker-compose.yml'
      - '.github/workflows/ci.yml'
      - '.github/workflows/cd.yml'
  workflow_run:
    workflows: ["CI - Build and Push to ACR"]
    types:
      - completed

env:
  IMAGE_NAME: prefect-worker

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only run if CI workflow succeeded or if directly triggered by push
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
          IMAGE_TAG: ${{ github.ref_name }}-${{ github.sha }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: ACR_LOGIN_SERVER,ACR_USERNAME,ACR_PASSWORD,IMAGE_TAG,IMAGE_NAME
          script: |
            set -e

            echo "ðŸš€ Starting deployment..."

            # Navigate to project directory
            cd ~/prefect || { echo "âŒ Project directory not found"; exit 1; }

            # Log in to Azure Container Registry
            echo "ðŸ” Logging in to ACR..."
            echo "$ACR_PASSWORD" | docker login "$ACR_LOGIN_SERVER" -u "$ACR_USERNAME" --password-stdin

            # Pull latest images
            echo "ðŸ“¦ Pulling latest images..."
            docker pull "${ACR_LOGIN_SERVER}/${IMAGE_NAME}:latest"

            # Update docker-compose to use ACR image
            echo "ðŸ“ Updating docker-compose.yml..."
            cat > docker-compose.prod.yml <<EOF
            services:
              postgres:
                image: postgres:16-alpine
                container_name: prefect-postgres
                environment:
                  POSTGRES_USER: prefect
                  POSTGRES_PASSWORD: prefect
                  POSTGRES_DB: prefect
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                healthcheck:
                  test: ["CMD-SHELL", "pg_isready -U prefect"]
                  interval: 10s
                  timeout: 5s
                  retries: 5
                networks:
                  - prefect-network
                restart: unless-stopped

              prefect-server:
                image: prefecthq/prefect:3-python3.11
                container_name: prefect-server
                command: prefect server start --host 0.0.0.0
                environment:
                  PREFECT_API_DATABASE_CONNECTION_URL: postgresql+asyncpg://prefect:prefect@postgres:5432/prefect
                  PREFECT_SERVER_API_HOST: 0.0.0.0
                  PREFECT_SERVER_API_PORT: 4200
                  PREFECT_UI_API_URL: http://localhost:4200/api
                ports:
                  - "4200:4200"
                depends_on:
                  postgres:
                    condition: service_healthy
                healthcheck:
                  test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:4200/api/health\")'"]
                  interval: 30s
                  timeout: 10s
                  retries: 5
                  start_period: 20s
                networks:
                  - prefect-network
                restart: unless-stopped

              prefect-worker:
                image: ${ACR_LOGIN_SERVER}/${IMAGE_NAME}:latest
                container_name: prefect-worker
                environment:
                  PREFECT_API_URL: http://prefect-server:4200/api
                depends_on:
                  prefect-server:
                    condition: service_healthy
                restart: unless-stopped
                networks:
                  - prefect-network

            volumes:
              postgres_data:

            networks:
              prefect-network:
                driver: bridge
            EOF

            # Stop and remove old containers
            echo "ðŸ›‘ Stopping old containers..."
            docker compose -f docker-compose.prod.yml down || true

            # Start new containers
            echo "â–¶ï¸  Starting new containers..."
            docker compose -f docker-compose.prod.yml up -d

            # Wait for services to be healthy
            echo "â³ Waiting for services to be healthy..."
            sleep 30

            # Check container status
            echo "ðŸ“Š Container status:"
            docker compose -f docker-compose.prod.yml ps

            # Show logs
            echo "ðŸ“‹ Recent logs:"
            docker compose -f docker-compose.prod.yml logs --tail=50 prefect-worker

            # Cleanup old images
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -af --filter "until=72h" || true

            echo "âœ… Deployment completed successfully!"

      - name: Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/prefect

            # Check if all containers are running
            if docker compose -f docker-compose.prod.yml ps | grep -q "Up"; then
              echo "âœ… Containers are running"
            else
              echo "âŒ Some containers are not running"
              docker compose -f docker-compose.prod.yml ps
              exit 1
            fi

            # Check Prefect API health
            if curl -f http://localhost:4200/api/health; then
              echo "âœ… Prefect API is healthy"
            else
              echo "âŒ Prefect API health check failed"
              exit 1
            fi

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment to VPS succeeded!"
          else
            echo "âŒ Deployment to VPS failed!"
          fi
